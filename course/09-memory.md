# –ú–æ–¥—É–ª—å 09: –ü–∞–º'—è—Ç—å –∞–≥–µ–Ω—Ç—ñ–≤ ‚Äî –ö–æ—Ä–æ—Ç–∫–æ—Å—Ç—Ä–æ–∫–æ–≤–∞ —Ç–∞ –¥–æ–≤–≥–æ—Å—Ç—Ä–æ–∫–æ–≤–∞

## üéØ –©–æ –≤–∏ –æ—Ç—Ä–∏–º–∞—î—Ç–µ –∑ —Ü—å–æ–≥–æ –º–æ–¥—É–ª—è

–ü—ñ—Å–ª—è –ø—Ä–æ—Ö–æ–¥–∂–µ–Ω–Ω—è –≤–∏ –±—É–¥–µ—Ç–µ:
- –†–æ–∑—É–º—ñ—Ç–∏ 3 —Ç–∏–ø–∏ –ø–∞–º'—è—Ç—ñ –∞–≥–µ–Ω—Ç–∞: in-context, extracted, vectorized
- –†–µ–∞–ª—ñ–∑–æ–≤—É–≤–∞—Ç–∏ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è —Ç–∞ –≤—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è –∫–æ–Ω—Ç–µ–∫—Å—Ç—É –º—ñ–∂ —Å–µ—Å—ñ—è–º–∏
- –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ sliding window —Ç–∞ summarization –¥–ª—è –¥–æ–≤–≥–∏—Ö —Ä–æ–∑–º–æ–≤
- –ë—É–¥—É–≤–∞—Ç–∏ hybrid memory –∑ SQL + –≤–µ–∫—Ç–æ—Ä–Ω–∏–º –ø–æ—à—É–∫–æ–º

**–Ø–∫—ñ –∑–∞–¥–∞—á—ñ —Ü–µ –¥–æ–∑–≤–æ–ª—è—î –≤–∏—Ä—ñ—à—É–≤–∞—Ç–∏:** –ó—Ä–æ–±–∏—Ç–∏ –∞–≥–µ–Ω—Ç–∞ —è–∫–∏–π "–ø–∞–º'—è—Ç–∞—î" –≤–∞—Å. –ü–µ—Ä—Å–æ–Ω–∞–ª—ñ–∑–∞—Ü—ñ—è –≤—ñ–¥–ø–æ–≤—ñ–¥–µ–π, –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è –∫–æ–Ω—Ç–µ–∫—Å—Ç—É –ø—Ä–æ–µ–∫—Ç—É –º—ñ–∂ —Å–µ—Å—ñ—è–º–∏, –Ω–∞–∫–æ–ø–∏—á–µ–Ω–Ω—è –∑–Ω–∞–Ω—å –∑ —Ä–æ–∑–º–æ–≤ ‚Äî –≤—Å–µ —â–æ –ø–µ—Ä–µ—Ç–≤–æ—Ä—é—î –æ–¥–Ω–æ—Ä–∞–∑–æ–≤–∏–π —á–∞—Ç–±–æ—Ç –Ω–∞ –ø–æ—Å—Ç—ñ–π–Ω–æ–≥–æ –∞—Å–∏—Å—Ç–µ–Ω—Ç–∞.

---

## üí∞ –ë—ñ–∑–Ω–µ—Å-—Ü—ñ–Ω–Ω—ñ—Å—Ç—å

**–ü—Ä–æ–±–ª–µ–º–∞ –∫–ª—ñ—î–Ω—Ç–∞:** "–ö–ª—ñ—î–Ω—Ç –ø–∏—à–µ –≤ —á–∞—Ç –≤–∂–µ —Ç—Ä–µ—Ç—ñ–π —Ä–∞–∑, –∞ AI –∑–Ω–æ–≤—É –ø–∏—Ç–∞—î '—è–∫ –≤–∞—Å –∑–≤–∞—Ç–∏?'"
**–†—ñ—à–µ–Ω–Ω—è –∑ —Ü—å–æ–≥–æ –º–æ–¥—É–ª—è:** –ü–∞–º'—è—Ç—å –º—ñ–∂ —Å–µ—Å—ñ—è–º–∏ ‚Äî AI –∑–Ω–∞—î —ñ—Å—Ç–æ—Ä—ñ—é –∫–ª—ñ—î–Ω—Ç–∞ —ñ –∫–æ–Ω—Ç–µ–∫—Å—Ç.
**–Ø–∫ –ø—Ä–æ–¥–∞—Ç–∏:** –ü–µ—Ä—Å–æ–Ω–∞–ª—ñ–∑–∞—Ü—ñ—è = –±—ñ–ª—å—à–µ –∫–æ–Ω–≤–µ—Ä—Å—ñ–π. –ö–ª—ñ—î–Ω—Ç–∏ —â–æ –≤—ñ–¥—á—É–≤–∞—é—Ç—å —â–æ —ó—Ö "–∑–Ω–∞—é—Ç—å" ‚Äî –ª–æ—è–ª—å–Ω—ñ—à—ñ –Ω–∞ 40%. –î–æ–¥–∞—î $3‚Äì5K –¥–æ –ø—Ä–æ–µ–∫—Ç—É.

## 9.1 –ü—Ä–æ–±–ª–µ–º–∞: LLM –Ω—ñ—á–æ–≥–æ –Ω–µ –ø–∞–º'—è—Ç–∞—î

–ó–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º LLM ‚Äî **stateless**. –ö–æ–∂–µ–Ω –∑–∞–ø–∏—Ç ‚Äî —Ü–µ –æ–∫—Ä–µ–º–∏–π –≤–∏–∫–ª–∏–∫ –±–µ–∑ –±—É–¥—å-—è–∫–æ–≥–æ –∑–≤'—è–∑–∫—É –∑ –ø–æ–ø–µ—Ä–µ–¥–Ω—ñ–º–∏:

```typescript
// –°–µ—Å—ñ—è 1
await generateText({ prompt: '–ú–µ–Ω–µ –∑–≤–∞—Ç–∏ –û–ª–µ–≥, —è –ø—Ä–∞—Ü—é—é –Ω–∞–¥ –ø—Ä–æ–µ–∫—Ç–æ–º ShopAI' });
// ‚Üí "–ü—Ä–∏–≤—ñ—Ç, –û–ª–µ–≥! –†–æ–∑–∫–∞–∂—ñ—Ç—å –±—ñ–ª—å—à–µ –ø—Ä–æ ShopAI..."

// –°–µ—Å—ñ—è 2 (–Ω–æ–≤–∞ —Ä–æ–∑–º–æ–≤–∞)
await generateText({ prompt: '–Ø–∫–µ –º–æ—î —ñ–º\'—è?' });
// ‚Üí "–Ø –Ω–µ –∑–Ω–∞—é –≤–∞—à–æ–≥–æ —ñ–º–µ–Ω—ñ, –≤–∏ –Ω–µ –ø–æ–≤—ñ–¥–æ–º–ª—è–ª–∏ –π–æ–≥–æ."
// LLM –ù–ï –ø–∞–º'—è—Ç–∞—î –ø–æ–ø–µ—Ä–µ–¥–Ω—é —Å–µ—Å—ñ—é!
```

–ü–∞–º'—è—Ç—å ‚Äî —Ü–µ **–≤–∞—à–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥–∞–ª—å–Ω—ñ—Å—Ç—å**. –ú–æ–¥–µ–ª—å –±–∞—á–∏—Ç—å —Ç—ñ–ª—å–∫–∏ —Ç–µ, —â–æ –≤–∏ –ø–µ—Ä–µ–¥–∞—î—Ç–µ –≤ `messages`.

---

## 9.2 –¢—Ä–∏ —Ç–∏–ø–∏ –ø–∞–º'—è—Ç—ñ

### In-Context Memory (–∫–æ—Ä–æ—Ç–∫–æ—Å—Ç—Ä–æ–∫–æ–≤–∞)

–ù–∞–π–ø—Ä–æ—Å—Ç—ñ—à–∏–π –ø—ñ–¥—Ö—ñ–¥ ‚Äî —Ç—Ä–∏–º–∞—Ç–∏ –≤—Å—é —ñ—Å—Ç–æ—Ä—ñ—é –≤ –º–∞—Å–∏–≤—ñ `messages`:

```typescript
import { generateText, CoreMessage } from 'ai';
import { openai } from '@ai-sdk/openai';

// –ó–±–µ—Ä—ñ–≥–∞—î–º–æ —ñ—Å—Ç–æ—Ä—ñ—é –≤ –ø–∞–º'—è—Ç—ñ –ø—Ä–æ—Ü–µ—Å—É
const conversationHistory: CoreMessage[] = [
  { role: 'system', content: '–¢–∏ ‚Äî –∞—Å–∏—Å—Ç–µ–Ω—Ç —Ä–æ–∑—Ä–æ–±–Ω–∏–∫–∞. –ó–∞–ø–∞–º\'—è—Ç–æ–≤—É–π –∫–æ–Ω—Ç–µ–∫—Å—Ç —Ä–æ–∑–º–æ–≤–∏.' },
];

async function chat(userMessage: string): Promise<string> {
  conversationHistory.push({ role: 'user', content: userMessage });

  const { text, usage } = await generateText({
    model: openai('gpt-4o-mini'),
    messages: conversationHistory,
  });

  conversationHistory.push({ role: 'assistant', content: text });

  console.log(`[${usage.totalTokens} —Ç–æ–∫–µ–Ω—ñ–≤, ${conversationHistory.length} –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å]`);
  return text;
}

// –ü—Ä–∞—Ü—é—î –≤ –º–µ–∂–∞—Ö –æ–¥–Ω—ñ—î—ó —Å–µ—Å—ñ—ó:
await chat('–ú–µ–Ω–µ –∑–≤–∞—Ç–∏ –û–ª–µ–≥');          // "–ü—Ä–∏–≤—ñ—Ç, –û–ª–µ–≥!"
await chat('–Ø–∫–µ –º–æ—î —ñ–º\'—è?');           // "–í–∞—Å –∑–≤–∞—Ç–∏ –û–ª–µ–≥."
await chat('–Ø –ø—Ä–∞—Ü—é—é –Ω–∞–¥ ShopAI');      // "–¶—ñ–∫–∞–≤–æ! –†–æ–∑–∫–∞–∂—ñ—Ç—å –ø—Ä–æ ShopAI..."
// –ê–ª–µ –∑ –∫–æ–∂–Ω–∏–º –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è–º —Ç–æ–∫–µ–Ω—ñ–≤ –±—ñ–ª—å—à–µ —ñ –≤–∞—Ä—Ç—ñ—Å—Ç—å —Ä–æ—Å—Ç–µ!
```

**–ü—Ä–æ–±–ª–µ–º–∞:** –í—ñ–∫–Ω–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç—É —Å–∫—ñ–Ω—á–∏—Ç—å—Å—è + –≤–∞—Ä—Ç—ñ—Å—Ç—å –∑—Ä–æ—Å—Ç–∞—î –ª—ñ–Ω—ñ–π–Ω–æ. –ü—ñ—Å–ª—è 100 –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å –≤–∏ –≤—ñ–¥–ø—Ä–∞–≤–ª—è—î—Ç–µ –í–°–Æ —ñ—Å—Ç–æ—Ä—ñ—é –∑ –∫–æ–∂–Ω–∏–º –∑–∞–ø–∏—Ç–æ–º.

### Sliding Window ‚Äî –æ–±–º–µ–∂—É—î–º–æ —ñ—Å—Ç–æ—Ä—ñ—é

```typescript
const MAX_MESSAGES = 20; // –¢—Ä–∏–º–∞—î–º–æ –æ—Å—Ç–∞–Ω–Ω—ñ 20 –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å

async function chatWithWindow(userMessage: string): Promise<string> {
  conversationHistory.push({ role: 'user', content: userMessage });

  // –ó–∞–≤–∂–¥–∏ —Ç—Ä–∏–º–∞—î–º–æ system prompt + –æ—Å—Ç–∞–Ω–Ω—ñ N –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å
  const systemMessage = conversationHistory[0];
  const recentMessages = conversationHistory.slice(-MAX_MESSAGES);
  const messages = [systemMessage, ...recentMessages];

  const { text } = await generateText({
    model: openai('gpt-4o-mini'),
    messages,
  });

  conversationHistory.push({ role: 'assistant', content: text });
  return text;
}
```

**–ú—ñ–Ω—É—Å:** –ê–≥–µ–Ω—Ç "–∑–∞–±—É–≤–∞—î" —â–æ –±—É–ª–æ –Ω–∞ –ø–æ—á–∞—Ç–∫—É —Ä–æ–∑–º–æ–≤–∏.

### Summarization ‚Äî —Å—Ç–∏—Å–Ω–µ–Ω–Ω—è —Å—Ç–∞—Ä–æ—ó —ñ—Å—Ç–æ—Ä—ñ—ó

```typescript
async function summarizeOldMessages(messages: CoreMessage[]): Promise<string> {
  const { text } = await generateText({
    model: openai('gpt-4o-mini'),
    temperature: 0,
    system: '–°—Ç–∏—Å–Ω–∏ –¥—ñ–∞–ª–æ–≥ —É –∫–æ—Ä–æ—Ç–∫–∏–π –ø—ñ–¥—Å—É–º–æ–∫. –ó–±–µ—Ä–µ–∂–∏: —ñ–º–µ–Ω–∞, —Ñ–∞–∫—Ç–∏, —Ä—ñ—à–µ–Ω–Ω—è, –∑–∞–¥–∞—á—ñ.',
    prompt: messages.map(m => `${m.role}: ${m.content}`).join('\n'),
  });
  return text;
}

async function chatWithSummary(userMessage: string): Promise<string> {
  conversationHistory.push({ role: 'user', content: userMessage });

  // –Ø–∫—â–æ —ñ—Å—Ç–æ—Ä—ñ—è —Å—Ç–∞–ª–∞ –∑–∞–Ω–∞–¥—Ç–æ –¥–æ–≤–≥–æ—é ‚Äî —Å—Ç–∏—Å–∫–∞—î–º–æ
  if (conversationHistory.length > 30) {
    const oldMessages = conversationHistory.slice(1, -10); // –ë–µ–∑ system —Ç–∞ –æ—Å—Ç–∞–Ω–Ω—ñ—Ö 10
    const summary = await summarizeOldMessages(oldMessages);

    // –ó–∞–º—ñ–Ω—é—î–º–æ —Å—Ç–∞—Ä—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –æ–¥–Ω–∏–º summary
    conversationHistory.splice(1, conversationHistory.length - 11, {
      role: 'assistant',
      content: `[–ü—ñ–¥—Å—É–º–æ–∫ –ø–æ–ø–µ—Ä–µ–¥–Ω—å–æ—ó —Ä–æ–∑–º–æ–≤–∏: ${summary}]`,
    });
  }

  const { text } = await generateText({
    model: openai('gpt-4o-mini'),
    messages: conversationHistory,
  });

  conversationHistory.push({ role: 'assistant', content: text });
  return text;
}
```

---

## 9.3 Extracted Memory ‚Äî —Ñ–∞–∫—Ç–∏ –∑ —Ä–æ–∑–º–æ–≤

–í–∏—Ç—è–≥—É—î–º–æ –≤–∞–∂–ª–∏–≤—ñ —Ñ–∞–∫—Ç–∏ –∑ –∫–æ–∂–Ω–æ—ó —Ä–æ–∑–º–æ–≤–∏ —ñ –∑–±–µ—Ä—ñ–≥–∞—î–º–æ –æ–∫—Ä–µ–º–æ:

```typescript
import { generateObject } from 'ai';
import { z } from 'zod';

const MemoryFact = z.object({
  facts: z.array(z.object({
    category: z.enum(['personal', 'project', 'preference', 'task', 'decision']),
    key: z.string().describe('–ö–æ—Ä–æ—Ç–∫–∏–π –∫–ª—é—á —Ñ–∞–∫—Ç—É'),
    value: z.string().describe('–°–∞–º —Ñ–∞–∫—Ç'),
    confidence: z.number().min(0).max(1),
  })),
});

async function extractMemories(messages: CoreMessage[]): Promise<z.infer<typeof MemoryFact>> {
  const { object } = await generateObject({
    model: openai('gpt-4o-mini'),
    schema: MemoryFact,
    temperature: 0,
    system: `–í–∏—Ç—è–≥–Ω–∏ –≤–∞–∂–ª–∏–≤—ñ —Ñ–∞–∫—Ç–∏ –∑ –¥—ñ–∞–ª–æ–≥—É.
–ó–±–µ—Ä–µ–∂–∏ —Ç—ñ–ª—å–∫–∏ —Ç–µ, —â–æ –º–æ–∂–µ –±—É—Ç–∏ –∫–æ—Ä–∏—Å–Ω–∏–º —É –º–∞–π–±—É—Ç–Ω—ñ—Ö —Ä–æ–∑–º–æ–≤–∞—Ö.
–ù–µ –∑–±–µ—Ä—ñ–≥–∞–π –∑–∞–≥–∞–ª—å–Ω—ñ –∑–Ω–∞–Ω–Ω—è ‚Äî —Ç—ñ–ª—å–∫–∏ —Å–ø–µ—Ü–∏—Ñ—ñ—á–Ω–µ –ø—Ä–æ —Ü—å–æ–≥–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞.`,
    prompt: messages.map(m => `${m.role}: ${m.content}`).join('\n'),
  });
  return object;
}

// –ü—Ä–∏–∫–ª–∞–¥ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—É –ø—ñ—Å–ª—è —Ä–æ–∑–º–æ–≤–∏:
// {
//   facts: [
//     { category: 'personal', key: 'name', value: '–û–ª–µ–≥', confidence: 1.0 },
//     { category: 'project', key: 'current_project', value: 'ShopAI ‚Äî AI-powered e-commerce', confidence: 0.9 },
//     { category: 'preference', key: 'language', value: 'TypeScript', confidence: 1.0 },
//     { category: 'preference', key: 'style', value: '–ö–æ—Ä–æ—Ç–∫—ñ –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ –∑ –ø—Ä–∏–∫–ª–∞–¥–∞–º–∏ –∫–æ–¥—É', confidence: 0.7 },
//   ]
// }
```

### –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è –≤ –±–∞–∑—É

```typescript
// –ü—Ä–æ—Å—Ç–∞ SQL-—Å—Ö–µ–º–∞ –¥–ª—è memory
const SCHEMA = `
CREATE TABLE IF NOT EXISTS memories (
  id TEXT PRIMARY KEY,
  user_id TEXT NOT NULL,
  category TEXT NOT NULL,
  key TEXT NOT NULL,
  value TEXT NOT NULL,
  confidence REAL DEFAULT 1.0,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_memories_user ON memories(user_id);
CREATE INDEX idx_memories_category ON memories(user_id, category);
`;

class MemoryStore {
  async save(userId: string, facts: MemoryFact['facts']) {
    for (const fact of facts) {
      // Upsert ‚Äî –æ–Ω–æ–≤–ª—é—î–º–æ —è–∫—â–æ —Ñ–∞–∫—Ç –≤–∂–µ —ñ—Å–Ω—É—î
      await db.query(`
        INSERT INTO memories (id, user_id, category, key, value, confidence)
        VALUES ($1, $2, $3, $4, $5, $6)
        ON CONFLICT (id) DO UPDATE SET
          value = $5, confidence = $6, updated_at = CURRENT_TIMESTAMP
      `, [
        `${userId}:${fact.category}:${fact.key}`,
        userId, fact.category, fact.key, fact.value, fact.confidence
      ]);
    }
  }

  async getForUser(userId: string): Promise<string> {
    const rows = await db.query(
      'SELECT category, key, value FROM memories WHERE user_id = $1 ORDER BY updated_at DESC LIMIT 50',
      [userId]
    );
    return rows.map(r => `[${r.category}] ${r.key}: ${r.value}`).join('\n');
  }
}
```

### –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è –≤ —Å–∏—Å—Ç–µ–º–Ω–æ–º—É –ø—Ä–æ–º–ø—Ç—ñ

```typescript
const memoryStore = new MemoryStore();

async function chatWithMemory(userId: string, message: string) {
  const memories = await memoryStore.getForUser(userId);

  const { text } = await generateText({
    model: openai('gpt-4o-mini'),
    system: `–¢–∏ ‚Äî –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∏–π AI-–∞—Å–∏—Å—Ç–µ–Ω—Ç.

–û—Å—å —â–æ —Ç–∏ –∑–Ω–∞—î—à –ø—Ä–æ —Ü—å–æ–≥–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞:
${memories || '–ü–æ–∫–∏ —â–æ –Ω—ñ—á–æ–≥–æ ‚Äî —Ü–µ –Ω–æ–≤–∞ —Ä–æ–∑–º–æ–≤–∞.'}

–í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π —Ü—é —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é –¥–ª—è –ø–µ—Ä—Å–æ–Ω–∞–ª—ñ–∑–∞—Ü—ñ—ó –≤—ñ–¥–ø–æ–≤—ñ–¥–µ–π.`,
    prompt: message,
  });

  return text;
}

// –¢–µ–ø–µ—Ä –Ω–∞–≤—ñ—Ç—å —É –ù–û–í–Ü–ô —Å–µ—Å—ñ—ó:
await chatWithMemory('user-123', '–Ø–∫–µ –º–æ—î —ñ–º\'—è?');
// ‚Üí "–í–∞—Å –∑–≤–∞—Ç–∏ –û–ª–µ–≥! –Ø–∫ –ø—Ä–æ—Å—É–≤–∞—î—Ç—å—Å—è ShopAI?"
```

---

## 9.4 Vectorized Memory ‚Äî —Å–µ–º–∞–Ω—Ç–∏—á–Ω–∏–π –ø–æ—à—É–∫ –ø–æ —Å–ø–æ–≥–∞–¥–∞—Ö

–î–ª—è –≤–µ–ª–∏–∫–æ—ó –∫—ñ–ª—å–∫–æ—Å—Ç—ñ —Ñ–∞–∫—Ç—ñ–≤ SQL-–ø–æ—à—É–∫ –∑–∞ –∫–ª—é—á–∞–º–∏ –Ω–µ–¥–æ—Å—Ç–∞—Ç–Ω—ñ–π. –ü–æ—Ç—Ä—ñ–±–µ–Ω **—Å–µ–º–∞–Ω—Ç–∏—á–Ω–∏–π –ø–æ—à—É–∫** ‚Äî –∑–Ω–∞—Ö–æ–¥–∏—Ç–∏ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ñ —Å–ø–æ–≥–∞–¥–∏ –∑–∞ –∑–º—ñ—Å—Ç–æ–º:

```typescript
import { embed } from 'ai';
import { openai } from '@ai-sdk/openai';

class VectorMemory {
  // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ —Å–ø–æ–≥–∞–¥ –∑ –≤–µ–∫—Ç–æ—Ä–æ–º
  async store(userId: string, text: string, metadata: Record<string, string>) {
    const { embedding } = await embed({
      model: openai.embedding('text-embedding-3-small'),
      value: text,
    });

    await db.query(`
      INSERT INTO memory_vectors (user_id, text, metadata, embedding)
      VALUES ($1, $2, $3, $4)
    `, [userId, text, JSON.stringify(metadata), JSON.stringify(embedding)]);
  }

  // –®—É–∫–∞—î–º–æ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ñ —Å–ø–æ–≥–∞–¥–∏
  async recall(userId: string, query: string, limit = 5): Promise<string[]> {
    const { embedding } = await embed({
      model: openai.embedding('text-embedding-3-small'),
      value: query,
    });

    // pgvector: –ø–æ—à—É–∫ –Ω–∞–π–±–ª–∏–∂—á–∏—Ö –≤–µ–∫—Ç–æ—Ä—ñ–≤
    const rows = await db.query(`
      SELECT text, 1 - (embedding <=> $1) as similarity
      FROM memory_vectors
      WHERE user_id = $2
      ORDER BY embedding <=> $1
      LIMIT $3
    `, [JSON.stringify(embedding), userId, limit]);

    return rows.map(r => r.text);
  }
}
```

–î–µ—Ç–∞–ª—å–Ω—ñ—à–µ –ø—Ä–æ –≤–µ–∫—Ç–æ—Ä–∏ —Ç–∞ embeddings ‚Äî —É –ú–æ–¥—É–ª—ñ 10 (RAG).

---

## 9.5 Hybrid Memory: –ü–æ–≤–Ω–∞ –∞—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä–∞

–ù–∞–π–∫—Ä–∞—â–∏–π –ø—ñ–¥—Ö—ñ–¥ –¥–ª—è production ‚Äî **–∫–æ–º–±—ñ–Ω–∞—Ü—ñ—è –≤—Å—ñ—Ö —Ç–∏–ø—ñ–≤**:

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ              –ó–∞–ø–∏—Ç –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞                  ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  1. Structured lookup (SQL)                    ‚îÇ
‚îÇ     ‚Üí –Ü–º'—è, –ø—Ä–æ–µ–∫—Ç, preferences                ‚îÇ
‚îÇ                                                ‚îÇ
‚îÇ  2. Vector search (—Å–µ–º–∞–Ω—Ç–∏—á–Ω–∏–π)                ‚îÇ
‚îÇ     ‚Üí –†–µ–ª–µ–≤–∞–Ω—Ç–Ω—ñ –ø–æ–ø–µ—Ä–µ–¥–Ω—ñ —Ä–æ–∑–º–æ–≤–∏             ‚îÇ
‚îÇ                                                ‚îÇ
‚îÇ  3. In-context (messages[])                    ‚îÇ
‚îÇ     ‚Üí –ü–æ—Ç–æ—á–Ω–∞ —Ä–æ–∑–º–æ–≤–∞ (sliding window)         ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ         System Prompt + –∑–Ω–∞–π–¥–µ–Ω–∏–π –∫–æ–Ω—Ç–µ–∫—Å—Ç      ‚îÇ
‚îÇ               ‚Üì                                ‚îÇ
‚îÇ              LLM                               ‚îÇ
‚îÇ               ‚Üì                                ‚îÇ
‚îÇ           –í—ñ–¥–ø–æ–≤—ñ–¥—å                             ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  4. –ü—ñ—Å–ª—è –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ: extract & save            ‚îÇ
‚îÇ     ‚Üí –ù–æ–≤—ñ —Ñ–∞–∫—Ç–∏ ‚Üí SQL + Vector               ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## –ü–µ—Ä–µ–≤—ñ—Ä —Å–µ–±–µ

1. –ß–æ–º—É LLM –Ω—ñ—á–æ–≥–æ –Ω–µ –ø–∞–º'—è—Ç–∞—î –º—ñ–∂ —Å–µ—Å—ñ—è–º–∏? –Ø–∫ —Ü–µ –≤–∏–ø—Ä–∞–≤–∏—Ç–∏?
2. –ß–∏–º sliding window –≤—ñ–¥—Ä—ñ–∑–Ω—è—î—Ç—å—Å—è –≤—ñ–¥ summarization? –ü–ª—é—Å–∏ —ñ –º—ñ–Ω—É—Å–∏ –∫–æ–∂–Ω–æ–≥–æ
3. –©–æ —Ç–∞–∫–µ extracted memory —ñ –∫–æ–ª–∏ –π–æ–≥–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏?
4. –†–µ–∞–ª—ñ–∑—É–π—Ç–µ –ø—Ä–æ—Å—Ç—É memory store —è–∫–∞ –∑–±–µ—Ä—ñ–≥–∞—î —Ñ–∞–∫—Ç–∏ –≤ JSON-—Ñ–∞–π–ª
5. –ß–æ–º—É hybrid memory –∫—Ä–∞—â–µ –Ω—ñ–∂ –æ–¥–∏–Ω –ø—ñ–¥—Ö—ñ–¥?

---

**–ù–∞–∑–∞–¥:** [‚Üê –ú–æ–¥—É–ª—å 08 ‚Äî AI –ê–≥–µ–Ω—Ç–∏](08-agents.md) | **–î–∞–ª—ñ:** [–ú–æ–¥—É–ª—å 10 ‚Äî RAG ‚Üí](10-rag.md)
